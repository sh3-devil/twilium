(window.webpackJsonptrilium=window.webpackJsonptrilium||[]).push([[800],{708:(t,e,n)=>{"use strict";n.d(e,{Z:()=>o});const o=class{constructor(t,e){this.treeCache=t,this.update(e)}update(t){this.attributeId=t.attributeId,this.noteId=t.noteId,this.type=t.type,this.name=t.name,this.value=t.value,this.position=t.position,this.isInheritable=t.isInheritable}getNote(){return this.treeCache.notes[this.noteId]}get targetNoteId(){return"relation"===this.type?this.value:void 0}get jsonValue(){try{return JSON.parse(this.value)}catch(t){return null}}get toString(){return`Attribute(attributeId=${this.attributeId}, type=${this.type}, name=${this.name}, value=${this.value})`}isAffecting(t){if(!t)return!1;const e=this.getNote();if(!e)return!1;const n=[t,...t.getTemplateNotes()];for(const t of n)if(t.noteId===e.noteId)return!0;if(this.isInheritable)for(const t of n)if(t.hasAncestor(e))return!0;return!1}}},215:(t,e,n)=>{"use strict";n.d(e,{Z:()=>o});const o=class{constructor(t,e){this.treeCache=t,this.update(e)}update(t){this.branchId=t.branchId,this.noteId=t.noteId,this.parentNoteId=t.parentNoteId,this.notePosition=t.notePosition,this.prefix=t.prefix,this.isExpanded=!!t.isExpanded,this.isDeleted=!!t.isDeleted}async getNote(){return this.treeCache.getNote(this.noteId)}async getParentNote(){return this.treeCache.getNote(this.parentNoteId)}isTopLevel(){return"root"===this.parentNoteId}get toString(){return`Branch(branchId=${this.branchId})`}}},95:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>S});var o=n(806),s=n(394),i=n(221);class a extends i.Z{jumpToNoteCommand(){n.e(667).then(n.bind(n,667)).then(t=>t.showDialog())}showRecentChangesCommand(){n.e(583).then(n.bind(n,583)).then(t=>t.showDialog())}showAttributesCommand(){n.e(453).then(n.bind(n,453)).then(t=>t.showDialog())}showNoteInfoCommand(){n.e(753).then(n.bind(n,753)).then(t=>t.showDialog())}showNoteRevisionsCommand(){n.e(387).then(n.bind(n,387)).then(t=>t.showCurrentNoteRevisions())}showNoteSourceCommand(){n.e(516).then(n.bind(n,516)).then(t=>t.showDialog())}showLinkMapCommand(){n.e(774).then(n.bind(n,774)).then(t=>t.showDialog())}pasteMarkdownIntoTextCommand(){n.e(665).then(n.bind(n,665)).then(t=>t.importMarkdownInline())}async editBranchPrefixCommand(){const t=S.tabManager.getActiveTabNotePath();if(t){(await n.e(233).then(n.bind(n,233))).showDialog(t)}}async cloneNoteIdsToCommand({noteIds:t}){(await n.e(365).then(n.bind(n,365))).showDialog(t)}async moveBranchIdsToCommand({branchIds:t}){(await n.e(704).then(n.bind(n,704))).showDialog(t)}showOptionsCommand(){n.e(152).then(n.bind(n,152)).then(t=>t.showDialog())}showHelpCommand(){n.e(461).then(n.bind(n,461)).then(t=>t.showDialog())}showSQLConsoleCommand(){n.e(205).then(n.bind(n,205)).then(t=>t.showDialog())}showBackendLogCommand(){n.e(639).then(n.bind(n,639)).then(t=>t.showDialog())}}var r=n(46),d=n(383),c=n(968),h=n(800),l=n(885),u=n(40),g=n(520);async function p(t,e={}){(e=Object.assign({activate:!0,target:"into"},e)).isProtected&&u.Z.isProtectedSessionAvailable()||(e.isProtected=!1),"text"!==S.tabManager.getActiveTabNoteType()&&(e.saveSelection=!1),e.saveSelection&&r.Z.isCKEditorInitialized()&&([e.title,e.content]=function(t){const e=$.parseHTML(t);if(e.length>0&&e[0].tagName&&e[0].tagName.match(/h[1-6]/i)){const n=$(e[0]).text(),o=t.replace(e[0].outerHTML,"");return[n,o]}return[null,t]}(window.cutToNote.getSelectedHtml()));const n=e.title||"new note",{note:o,branch:s}=await h.Z.post(`notes/${t}/children?target=${e.target}&targetBranchId=${e.targetBranchId}`,{title:n,content:e.content||"",isProtected:e.isProtected,type:e.type});if(e.saveSelection&&r.Z.isCKEditorInitialized()&&window.cutToNote.removeSelection(),e.activate){await g.Z.waitForMaxKnownSyncId();const t=S.tabManager.getActiveTabContext();await t.setNote(o.noteId),S.triggerCommand("focusAndSelectTitle")}return{note:o,branch:s}}const b={createNote:p,createNewTopLevelNote:async function(){const t=c.Z.getHoistedNoteId();await p(t)},duplicateNote:async function(t,e){const{note:n}=await h.Z.post(`notes/${t}/duplicate/${e}`);await g.Z.waitForMaxKnownSyncId(),await S.tabManager.activateOrOpenNote(n.noteId);const s=await o.Z.getNote(t);l.default.showMessage(`Note "${s.title}" has been duplicated`)}};class f extends i.Z{constructor(){super(),jQuery.hotkeys&&(jQuery.hotkeys.options.filterInputAcceptingElements=!1,jQuery.hotkeys.options.filterContentEditable=!1,jQuery.hotkeys.options.filterTextInputs=!1),$(document).on("click","a[data-action='note-revision']",async t=>{const e=$(t.target),o=e.attr("data-note-path"),s=e.attr("data-note-revision-id");return(await n.e(387).then(n.bind(n,387))).showNoteRevisionsDialog(o,s),!1})}openDevToolsCommand(){r.Z.isElectron()&&r.Z.dynamicRequire("electron").remote.getCurrentWindow().toggleDevTools()}findInTextCommand(){if(!r.Z.isElectron())return;const{remote:t}=r.Z.dynamicRequire("electron"),{FindInPage:e}=r.Z.dynamicRequire("electron-find");new e(t.getCurrentWebContents(),{offsetTop:10,offsetRight:10,boxBgColor:"var(--main-background-color)",boxShadowColor:"#000",inputColor:"var(--input-text-color)",inputBgColor:"var(--input-background-color)",inputFocusColor:"#555",textColor:"var(--main-text-color)",textHoverBgColor:"#555",caseSelectedColor:"var(--main-border-color)"}).openFindWindow()}async createNoteIntoDayNoteCommand(){const t=await d.Z.getTodayNote(),{note:e}=await h.Z.post(`notes/${t.noteId}/children?target=into`,{title:"new note",content:"",type:"text",isProtected:t.isProtected});await g.Z.waitForMaxKnownSyncId(),await S.tabManager.openTabWithNote(e.noteId,!0),S.triggerEvent("focusAndSelectTitle")}async toggleNoteHoistingCommand(){const t=S.tabManager.getActiveTabNote(),e=c.Z.getHoistedNoteId();t.noteId===e?c.Z.unhoist():"search"!==t.type&&c.Z.setHoistedNoteId(t.noteId)}copyWithoutFormattingCommand(){r.Z.copySelectionToClipboard()}toggleFullscreenCommand(){if(r.Z.isElectron()){const t=r.Z.dynamicRequire("electron").remote.getCurrentWindow();t.isFullScreenable()&&t.setFullScreen(!t.isFullScreen())}else this.$widget.find(".toggle-fullscreen-button").hide()}toggleZenModeCommand(){this.zenModeActive?($(".hide-in-zen-mode,.gutter").removeClass("hidden-by-zen-mode"),$("#root-widget").removeClass("zen-mode"),this.zenModeActive=!1):($(".hide-in-zen-mode,.gutter").addClass("hidden-by-zen-mode"),$("#root-widget").addClass("zen-mode"),this.zenModeActive=!0)}reloadFrontendAppCommand(){r.Z.reloadApp()}logoutCommand(){const t=$('<form action="logout" method="POST">').append($(`<input type="hidden" name="_csrf" value="${glob.csrfToken}"/>`));$("body").append(t),t.trigger("submit")}backInNoteHistoryCommand(){if(r.Z.isElectron()){const t=r.Z.dynamicRequire("electron").remote.getCurrentWebContents(),e=parseInt(t.getActiveIndex());t.goToIndex(e-1)}else window.history.back()}forwardInNoteHistoryCommand(){if(r.Z.isElectron()){const t=r.Z.dynamicRequire("electron").remote.getCurrentWebContents(),e=parseInt(t.getActiveIndex());t.goToIndex(e+1)}else window.history.forward()}async searchForResultsCommand({searchText:t}){const e=await h.Z.get("search/"+encodeURIComponent(t));e.success?(this.triggerEvent("searchResults",{results:e.results}),l.default.showMessage("Search finished successfully.")):l.default.showError("Search failed.",3e3)}async switchToDesktopVersionCommand(){r.Z.setCookie("trilium-device","desktop"),r.Z.reloadApp()}createTopLevelNoteCommand(){b.createNewTopLevelNote()}async openInWindowCommand({notePath:t}){if(r.Z.isElectron()){const{ipcRenderer:e}=r.Z.dynamicRequire("electron");e.send("create-extra-window",{notePath:t})}else{const e=window.location.protocol+"//"+window.location.host+window.location.pathname+"?extra=1#"+t;window.open(e,"","width=1000,height=800")}}async openNewWindowCommand(){this.openInWindowCommand({notePath:""})}async runActiveNoteCommand(){const t=S.tabManager.getActiveTabNote();t&&"code"===t.type&&(t.mime.endsWith("env=frontend")&&await s.Z.getAndExecuteBundle(t.noteId),t.mime.endsWith("env=backend")&&await h.Z.post("script/run/"+t.noteId),l.default.showMessage("Note executed"))}}var w=n(378);class m extends i.Z{constructor(){super(),r.Z.isElectron()&&w.Z.initializedPromise.then(()=>{this.setZoomFactor(w.Z.getFloat("zoomFactor"))})}setZoomFactor(t){t=parseFloat(t),r.Z.dynamicRequire("electron").webFrame.setZoomFactor(t)}async setZoomFactorAndSave(t){t>=.5&&t<=2?(this.setZoomFactor(t),await w.Z.save("zoomFactor",t)):console.log(`Zoom factor ${t} outside of the range, ignored.`)}getCurrentZoom(){return r.Z.dynamicRequire("electron").webFrame.getZoomFactor()}zoomOutEvent(){this.setZoomFactorAndSave(this.getCurrentZoom()-.1)}zoomInEvent(){this.setZoomFactorAndSave(this.getCurrentZoom()+.1)}setZoomFactorAndSaveEvent({zoomFactor:t}){this.setZoomFactorAndSave(t)}}const I=new m;class y{constructor(t,e=1e3){this.updater=t,this.lastUpdated=Date.now(),this.changed=!1,this.updateInterval=e}scheduleUpdate(){this.changeForbidden||(this.changed=!0,setTimeout(()=>this.triggerUpdate()))}async updateNowIfNecessary(){this.changed&&(this.changed=!1,await this.updater())}triggerUpdate(){this.changed&&(Date.now()-this.lastUpdated>this.updateInterval?(this.updater(),this.lastUpdated=Date.now(),this.changed=!1):this.scheduleUpdate())}async allowUpdateWithoutChange(t){this.changeForbidden=!0;try{await t()}finally{this.changeForbidden=!1}}}var v=n(481);class N extends i.Z{constructor(t=null){super(),this.tabId=t||r.Z.randomString(4)}setEmpty(){this.triggerEvent("tabNoteSwitched",{tabContext:this,notePath:this.notePath})}async setNote(t,e=!0){const n=v.Z.getNoteIdFromNotePath(t);let s;if((await o.Z.getNote(n)).isDeleted)s=t;else{if(s=await v.Z.resolveNotePath(t),!s)return void console.error("Cannot resolve note path "+t);if(s===this.notePath)return;if(!1===await c.Z.checkNoteAccess(s))return}await this.triggerEvent("beforeNoteSwitch",{tabContext:this}),r.Z.closeActiveDialog(),this.notePath=s,this.noteId=n,this.autoBookDisabled=!1,this.textPreviewDisabled=!1,this.codePreviewDisabled=!1,setTimeout(async()=>{s&&s===this.notePath&&await h.Z.post("recent-notes",{noteId:this.note.noteId,notePath:this.notePath})},5e3),u.Z.touchProtectedSessionIfNecessary(this.note),e&&await this.triggerEvent("tabNoteSwitched",{tabContext:this,notePath:this.notePath})}get note(){return o.Z.notes[this.noteId]}async getNoteComplement(){return this.noteId?await o.Z.getNoteComplement(this.noteId):null}isActive(){return S.tabManager.activeTabId===this.tabId}getTabState(){return this.notePath?{tabId:this.tabId,notePath:this.notePath,active:this.isActive()}:null}async entitiesReloadedEvent({loadResults:t}){if(t.isNoteReloaded(this.noteId)){(await o.Z.getNote(this.noteId)).isDeleted&&(this.noteId=null,this.notePath=null,this.triggerEvent("tabNoteSwitched",{tabContext:this,notePath:this.notePath}))}}}const C=N;class Z extends i.Z{constructor(){super(),this.activeTabId=null,this.tabsUpdate=new y(async()=>{if(!S.isMainWindow)return;const t=this.tabContexts.map(t=>t.getTabState()).filter(t=>!!t);await h.Z.put("options",{openTabs:JSON.stringify(t)})})}get tabContexts(){return this.children}async loadTabs(){const t=S.isMainWindow&&w.Z.getJson("openTabs")||[];if(window.location.hash){const e=window.location.hash.substr(1),n=v.Z.getNoteIdFromNotePath(e);if(n&&await o.Z.noteExists(n)){for(const e of t)e.active=!1;const o=t.find(t=>n===v.Z.getNoteIdFromNotePath(t.notePath));o?o.active=!0:t.push({notePath:e,active:!0})}}let e=[];for(const n of t){const t=v.Z.getNoteIdFromNotePath(n.notePath);await o.Z.noteExists(t)&&e.push(n)}r.Z.isMobile()&&(e=e.filter(t=>t.active)),0===e.length&&e.push({notePath:this.isMainWindow?"root":"",active:!0}),e.find(t=>t.active)||(e[0].active=!0),await this.tabsUpdate.allowUpdateWithoutChange(async()=>{for(const t of e)await this.openTabWithNote(t.notePath,t.active,t.tabId)})}tabNoteSwitchedEvent({tabContext:t}){t.isActive()&&this.setCurrentNotePathToHash(),this.tabsUpdate.scheduleUpdate()}setCurrentNotePathToHash(){const t=this.getActiveTabContext();if(0===window.history.length||t&&t.notePath!==v.Z.getHashValueFromAddress()[0]){const e="#"+(t.notePath||"")+"-"+t.tabId;window.history.pushState(null,"",e),document.title="Trilium Notes",t.note&&(document.title+=" - "+t.note.title)}this.triggerEvent("activeNoteChanged")}getTabContexts(){return this.tabContexts}getTabContextById(t){return this.tabContexts.find(e=>e.tabId===t)}getActiveTabContext(){return this.getTabContextById(this.activeTabId)}getActiveTabNotePath(){const t=this.getActiveTabContext();return t?t.notePath:null}getActiveTabNote(){const t=this.getActiveTabContext();return t?t.note:null}getActiveTabNoteId(){const t=this.getActiveTabNote();return t?t.noteId:null}getActiveTabNoteType(){const t=this.getActiveTabNote();return t?t.type:null}async switchToTab(t,e){const n=this.tabContexts.find(e=>e.tabId===t)||await this.openEmptyTab();this.activateTab(n.tabId),await n.setNote(e)}async openAndActivateEmptyTab(){const t=await this.openEmptyTab();await this.activateTab(t.tabId),await t.setEmpty()}async openEmptyTab(t){const e=new C(t);return this.child(e),await this.triggerEvent("newTabOpened",{tabContext:e}),e}async openTabWithNote(t,e,n=null){const o=await this.openEmptyTab(n);t&&await o.setNote(t,!e),e&&(this.activateTab(o.tabId,!1),await this.triggerEvent("tabNoteSwitchedAndActivated",{tabContext:o,notePath:o.notePath}))}async activateOrOpenNote(t){for(const e of this.getTabContexts())if(e.note&&e.note.noteId===t)return void this.activateTab(e.tabId);await this.openTabWithNote(t,!0)}activateTab(t,e=!0){t!==this.activeTabId&&(this.activeTabId=t,e&&this.triggerEvent("activeTabChanged",{tabContext:this.getTabContextById(t)}),this.tabsUpdate.scheduleUpdate(),this.setCurrentNotePathToHash())}async removeTab(t){const e=this.getTabContextById(t);if(e){if($(".aa-input").autocomplete("close"),await this.triggerEvent("beforeTabRemove",{tabId:t}),this.tabContexts.length<=1)this.openAndActivateEmptyTab();else if(e.isActive()){this.tabContexts.findIndex(e=>e.tabId===t)===this.tabContexts.length-1?this.activatePreviousTabCommand():this.activateNextTabCommand()}this.children=this.children.filter(e=>e.tabId!==t),this.triggerEvent("tabRemoved",{tabId:t}),this.tabsUpdate.scheduleUpdate()}}tabReorderEvent({tabIdsInOrder:t}){const e={};for(const n in t)e[t[n]]=n;this.children.sort((t,n)=>e[t.tabId]<e[n.tabId]?-1:1),this.tabsUpdate.scheduleUpdate()}activateNextTabCommand(){const t=this.tabContexts.findIndex(t=>t.tabId===this.activeTabId),e=this.tabContexts[t===this.tabContexts.length-1?0:t+1].tabId;this.activateTab(e)}activatePreviousTabCommand(){const t=this.tabContexts.findIndex(t=>t.tabId===this.activeTabId),e=this.tabContexts[0===t?this.tabContexts.length-1:t-1].tabId;this.activateTab(e)}closeActiveTabCommand(){this.removeTab(this.activeTabId)}beforeUnloadEvent(){this.tabsUpdate.updateNowIfNecessary()}openNewTabCommand(){this.openAndActivateEmptyTab()}async removeAllTabsCommand(){for(const t of this.tabContexts.map(t=>t.tabId))await this.removeTab(t)}async removeAllTabsExceptForThisCommand({tabId:t}){for(const e of this.tabContexts.map(t=>t.tabId))e!==t&&await this.removeTab(e)}moveTabToNewWindowCommand({tabId:t}){const e=this.getTabContextById(t).notePath;this.removeTab(t),this.triggerCommand("openInWindow",{notePath:e})}async hoistedNoteChangedEvent({hoistedNoteId:t}){if("root"!==t)for(const e of this.tabContexts.splice())e.notePath&&!e.notePath.split("/").includes(t)&&await this.removeTab(e.tabId)}}var T=n(604);class x extends i.Z{setActiveScreenCommand({screen:t}){t!==this.activeScreen&&(this.activeScreen=t,this.triggerEvent("activeScreenChanged",{activeScreen:t}))}initialRenderCompleteEvent(){this.setActiveScreenCommand({screen:"tree"})}}class P extends i.Z{get tree(){return S.mainTreeWidget}async cloneNotesToCommand(){const t=this.tree.getSelectedOrActiveNodes().map(t=>t.data.noteId);this.triggerCommand("cloneNoteIdsTo",{noteIds:t})}async moveNotesToCommand(){const t=this.tree.getSelectedOrActiveNodes().map(t=>t.data.branchId);this.triggerCommand("moveBranchIdsTo",{branchIds:t})}async createNoteIntoCommand(){const t=S.tabManager.getActiveTabNote();t&&await b.createNote(t.noteId,{isProtected:t.isProtected,saveSelection:!1})}async createNoteAfterCommand(){const t=this.tree.getActiveNode(),e=t.data.parentNoteId,n=await v.Z.getParentProtectedStatus(t);"root"!==t.data.noteId&&t.data.noteId!==c.Z.getHoistedNoteId()&&await b.createNote(e,{target:"after",targetBranchId:t.data.branchId,isProtected:n,saveSelection:!1})}}class A extends i.Z{constructor(t){super(),this.isMainWindow=t,this.executors=[]}setLayout(t){this.layout=t}async start(){await Promise.all([o.Z.initializedPromise,w.Z.initializedPromise]),$("#loading-indicator").hide(),this.showWidgets(),this.tabManager.loadTabs(),r.Z.isDesktop()&&setTimeout(()=>s.Z.executeStartupBundles(),2e3)}showWidgets(){const t=this.layout.getRootWidget(this),e=t.render();T.default.updateDisplayedShortcuts(e),$("body").append(e),e.on("click","[data-trigger-command]",(function(){const t=$(this).attr("data-trigger-command");$(this).closest(".component").prop("component").triggerCommand(t,{$el:$(this)})})),this.tabManager=new Z,this.executors=[this.tabManager,new a,new f,new P],r.Z.isMobile()&&this.executors.push(new x),this.child(t);for(const t of this.executors)this.child(t);r.Z.isElectron()&&this.child(I),this.triggerEvent("initialRenderComplete")}triggerEvent(t,e){return this.handleEvent(t,e)}triggerCommand(t,e={}){for(const n of this.executors){const o=n[t+"Command"];if(o)return n.callMethod(o,e)}return console.debug(`Unhandled command ${t}, converting to event.`),this.triggerEvent(t,e)}getComponentByEl(t){return $(t).closest(".component").prop("component")}}const E=new A(window.glob.isMainWindow);$(window).on("beforeunload",()=>{E.triggerEvent("beforeUnload")}),$(window).on("hashchange",(function(){if(function(){const[t,e]=v.Z.getHashValueFromAddress();return t.startsWith("root")||""===t&&!!e}()){const[t,e]=v.Z.getHashValueFromAddress();if(!t)return void console.log(`Invalid hash value "${document.location.hash}", ignoring.`);E.tabManager.switchToTab(e,t)}}));const S=E},394:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{Z:()=>__WEBPACK_DEFAULT_EXPORT__});var _script_context_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(9),_server_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(800),_toast_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(885);async function getAndExecuteBundle(t,e=null){const n=await _server_js__WEBPACK_IMPORTED_MODULE_1__.Z.get("script/bundle/"+t);return await executeBundle(n,e)}async function executeBundle(bundle,originEntity,$container){const apiContext=await(0,_script_context_js__WEBPACK_IMPORTED_MODULE_0__.Z)(bundle.noteId,bundle.allNoteIds,originEntity,$container);try{return await function(){return eval(`const apiContext = this; (async function() { ${bundle.script}\r\n})()`)}.call(apiContext)}catch(t){_toast_js__WEBPACK_IMPORTED_MODULE_2__.default.showAndLogError(`Execution of ${bundle.noteId} failed with error: ${t.message}`)}}async function executeStartupBundles(){const t=await _server_js__WEBPACK_IMPORTED_MODULE_1__.Z.get("script/startup");for(const e of t)await executeBundle(e)}class WidgetsByParent{constructor(){this.byParent={}}add(t){t.parentWidget?(this.byParent[t.parentWidget]=this.byParent[t.parentWidget]||[],this.byParent[t.parentWidget].push(t)):console.log("Custom widget does not have mandatory 'getParent()' method defined")}get(t){return this.byParent[t]||[]}}async function getWidgetBundlesByParent(){const t=await _server_js__WEBPACK_IMPORTED_MODULE_1__.Z.get("script/widgets"),e=new WidgetsByParent;for(const n of t){let t;try{t=await executeBundle(n)}catch(t){console.error("Widget initialization failed: ",t);continue}e.add(t)}return e}const __WEBPACK_DEFAULT_EXPORT__={executeBundle,getAndExecuteBundle,executeStartupBundles,getWidgetBundlesByParent}},383:(t,e,n)=>{"use strict";n.d(e,{Z:()=>a});var o=n(806),s=n(800);async function i(t){const e=await s.Z.get("date-notes/date/"+t,"date-note");return await o.Z.getNote(e.noteId)}const a={getTodayNote:async function(){return await i(dayjs().format("YYYY-MM-DD"))},getDateNote:i,getMonthNote:async function(t){const e=await s.Z.get("date-notes/month/"+t,"date-note");return await o.Z.getNote(e.noteId)},getYearNote:async function(t){const e=await s.Z.get("date-notes/year/"+t,"date-note");return await o.Z.getNote(e.noteId)}}},968:(t,e,n)=>{"use strict";n.d(e,{Z:()=>h});var o=n(378),s=n(95),i=n(481);function a(){return o.Z.get("hoistedNoteId")}async function r(t){await o.Z.save("hoistedNoteId",t),s.default.triggerEvent("hoistedNoteChanged",{noteId:t})}async function d(){await r("root")}function c(t){return"root"===t.data.noteId||t.data.noteId===a()}const h={getHoistedNoteId:a,setHoistedNoteId:r,unhoist:d,isTopLevelNode:function(t){return c(t.getParent())},isRootNode:c,checkNoteAccess:async function(t){const e=await i.Z.getRunPath(t);if(!e)return console.log("Cannot activate "+t),!1;const o=a();if("root"!==o&&!e.includes(o)){const t=await n.e(590).then(n.bind(n,590));if(!await t.confirm("Requested note is outside of hoisted note subtree and you must unhoist to access the note. Do you want to proceed with unhoisting?"))return!1;await d()}return!0}}},604:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>h});var o=n(800),s=n(46),i=n(95);const a={},r=o.Z.get("keyboard-actions").then(t=>{t=t.filter(t=>!!t.actionName);for(const e of t)e.effectiveShortcuts=e.effectiveShortcuts.filter(t=>!t.startsWith("global:")),a[e.actionName]=e;return t});async function d(t){return(await r).filter(e=>e.scope===t)}async function c(t,e=!1){await r;const n=a[t];if(!n){if(!e)throw new Error("Cannot find action "+t);console.log("Cannot find action "+t)}return n}d("window").then(t=>{for(const e of t)for(const t of e.effectiveShortcuts)s.Z.bindGlobalShortcut(t,()=>i.default.triggerCommand(e.actionName))}),o.Z.get("keyboard-shortcuts-for-notes").then(t=>{for(const e in t)s.Z.bindGlobalShortcut(e,async()=>{i.default.tabManager.getActiveTabContext().setNote(t[e])})});const h={setElementActionHandler:function(t,e,n){r.then(()=>{const o=a[e];if(!o)throw new Error(`Cannot find keyboard action '${e}'`);for(const e of o.effectiveShortcuts)e&&s.Z.bindElShortcut(t,e,n)})},updateDisplayedShortcuts:function(t){t.find("kbd[data-command]").each(async(t,e)=>{const n=$(e).attr("data-command"),o=await c(n,!0);o&&$(e).text(o.effectiveShortcuts.join(", "))}),t.find("[data-trigger-command]").each(async(t,e)=>{const n=$(e).attr("data-trigger-command"),o=await c(n,!0);if(o){const t=$(e).attr("title"),n=o.effectiveShortcuts.join(", "),s=t&&t.trim()?`${t} (${n})`:n;$(e).attr("title",s)}})},setupActionsForElement:async function(t,e,n){const o=await d(t);for(const t of o)for(const o of t.effectiveShortcuts)s.Z.bindElShortcut(e,o,()=>n.triggerCommand(t.actionName))},getActionsForScope:d}},985:(t,e,n)=>{"use strict";n.d(e,{Z:()=>l});var o=n(481),s=n(604);const i=new class{constructor(){this.$widget=$("#context-menu-container"),this.dateContextMenuOpenedMs=0,$(document).on("click",()=>this.hide())}async show(t){this.options=t,this.$widget.empty(),this.addItems(this.$widget,t.items),s.default.updateDisplayedShortcuts(this.$widget),this.positionMenu(),this.dateContextMenuOpenedMs=Date.now()}positionMenu(){const t=document.documentElement.clientHeight,e=this.$widget.outerHeight()+30;let n;n=this.options.y+e>t?t-e-10:this.options.y-10,this.$widget.css({display:"block",top:n,left:this.options.x-20}).addClass("show")}addItems(t,e){for(const n of e)if("----"===n.title)t.append($("<div>").addClass("dropdown-divider"));else{const e=$("<span>");n.uiIcon?e.addClass("bx bx-"+n.uiIcon):e.append("&nbsp;");const o=$("<span>").append(e).append(" &nbsp; ").append(n.title),s=$("<li>").addClass("dropdown-item").append(o).on("mousedown",t=>(t.stopPropagation(),this.hide(),n.handler&&n.handler(n,t),this.options.selectMenuItemHandler(n,t),!1));if(void 0===n.enabled||n.enabled||s.addClass("disabled"),n.items){s.addClass("dropdown-submenu"),o.addClass("dropdown-toggle");const t=$("<ul>").addClass("dropdown-menu");this.addItems(t,n.items),s.append(t)}t.append(s)}}hide(){Date.now()-this.dateContextMenuOpenedMs>300&&this.$widget.hide()}};var a=n(95);function r(t){const e=/#(root[A-Za-z0-9/]*)$/.exec(t);return null===e?null:e[1]}function d(t){const e=t.attr("data-note-path");if(e)return e;const n=t.attr("href");return n?r(n):null}function c(t){t.preventDefault(),t.stopPropagation();const e=$(t.target).closest("a"),n=d(e);if(n)if(1===t.which&&t.ctrlKey||2===t.which)a.default.tabManager.openTabWithNote(n);else{if(1!==t.which)return!1;a.default.tabManager.getActiveTabContext().setNote(n)}else{if(1!==t.which)return!1;{const t=e.attr("href");t&&t.startsWith("http")&&window.open(t,"_blank")}}return!0}function h(t){const e=d($(t.target).closest("a"));e&&(t.preventDefault(),i.show({x:t.pageX,y:t.pageY,items:[{title:"Open note in new tab",command:"openNoteInNewTab",uiIcon:"empty"},{title:"Open note in new window",command:"openNoteInNewWindow",uiIcon:"window-open"}],selectMenuItemHandler:({command:t})=>{"openNoteInNewTab"===t?a.default.tabManager.openTabWithNote(e):"openNoteInNewWindow"===t&&a.default.openInNewWindow(e)}}))}$(document).on("mousedown","a[data-action='note']",c),$(document).on("mousedown","div.popover-content a, div.ui-tooltip-content a",c),$(document).on("dblclick",".note-detail-text a",c),$(document).on("mousedown",".note-detail-text a:not(.reference-link)",(function(t){const e=$(t.target).closest("a"),n=d(e);if(1===t.which&&t.ctrlKey||2===t.which){if(t.preventDefault(),n)a.default.tabManager.openTabWithNote(n,!1);else{const t=e.attr("href");window.open(t,"_blank")}return!0}})),$(document).on("mousedown",".note-detail-book a",c),$(document).on("mousedown",".note-detail-render a",c),$(document).on("mousedown",".note-detail-text a.reference-link",c),$(document).on("mousedown",".note-detail-readonly-text a.reference-link",c),$(document).on("mousedown",".note-detail-readonly-text a",c),$(document).on("mousedown","a.ck-link-actions__preview",c),$(document).on("click","section.include-note a",c),$(document).on("click","a.ck-link-actions__preview",t=>{t.preventDefault(),t.stopPropagation()}),$(document).on("contextmenu","a.ck-link-actions__preview",h),$(document).on("contextmenu",".note-detail-text a",h),$(document).on("contextmenu",".note-detail-readonly-text a",h),$(document).on("contextmenu","a[data-action='note']",h),$(document).on("contextmenu",".note-detail-render a",h),$(document).on("contextmenu",".note-paths-widget a",h),$(document).on("contextmenu","section.include-note a",h);const l={getNotePathFromUrl:r,createNoteLink:async function(t,e={}){if(!t||!t.trim())return console.error("Missing note path"),$("<span>").text("[missing note]");let n=e.title;const s=void 0===e.showTooltip||e.showTooltip,i=void 0!==e.showNotePath&&e.showNotePath;if(!n){const{noteId:e,parentNoteId:s}=o.Z.getNoteIdAndParentIdFromNotePath(t);n=await o.Z.getNoteTitle(e,s)}const a=$("<a>",{href:"javascript:",text:n}).attr("data-action","note").attr("data-note-path",t);s||a.addClass("no-tooltip-preview");const r=$("<span>").append(a);if(i&&(t=await o.Z.resolveNotePath(t))){const e=t.split("/");e.pop();const n=e.join("/").trim();n&&r.append($("<small>").text(" ("+await o.Z.getNotePathTitle(n)+")"))}return r},goToLink:c}},342:(t,e,n)=>{"use strict";n.d(e,{Z:()=>o});const o=new class{constructor(){this.attributes={}}invalidate(){this.attributes={}}}},378:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var o=n(800);const s=new class{constructor(){this.initializedPromise=o.Z.get("options").then(t=>this.load(t))}load(t){this.arr=t}get(t){return this.arr[t]}getNames(){return Object.keys(this.arr)}getJson(t){try{return JSON.parse(this.arr[t])}catch(t){return null}}getInt(t){return parseInt(this.arr[t])}getFloat(t){return parseFloat(this.arr[t])}is(t){return"true"===this.arr[t]}set(t,e){this.arr[t]=e}async save(t,e){this.set(t,e);const n={};n[t]=e,await o.Z.put("options",n)}}},336:(t,e,n)=>{"use strict";n.d(e,{Z:()=>u});n(46);var o=n(800),s=n(40),i=n(885),a=n(520),r=n(95),d=n(806);let c=null;function h(){const t=$.Deferred();return s.Z.isProtectedSessionAvailable()?t.resolve(!1):(c=t,n.e(261).then(n.bind(n,261)).then(t=>t.show())),t.promise()}function l(t,e,n){return{id:t.taskId,title:e+" status",message:n,icon:t.data.protect?"check-shield":"shield"}}a.Z.subscribeToMessages(async t=>{if("protect-notes"!==t.taskType)return;const e=t.data.protect?"Protecting":"Unprotecting";if("task-error"===t.type)i.default.closePersistent(t.taskId),i.default.showError(t.message);else if("task-progress-count"===t.type)i.default.showPersistent(l(t,e,e+" in progress: "+t.progressCount));else if("task-succeeded"===t.type){const n=l(t,e,e+" finished successfully.");n.closeAfter=3e3,i.default.showPersistent(n)}});const u={protectNote:async function(t,e,n){await h(),await o.Z.put(`notes/${t}/protect/${e?1:0}?subtree=${n?1:0}`)},enterProtectedSession:h,leaveProtectedSession:async function(){s.Z.isProtectedSessionAvailable()&&s.Z.resetProtectedSession()},setupProtectedSession:async function(t){const e=await async function(t){return await o.Z.post("login/protected",{password:t})}(t);e.success?(s.Z.setProtectedSessionId(e.protectedSessionId),s.Z.touchProtectedSession(),await async function(){const t=Object.keys(d.Z.notes);await d.Z.loadInitialTree(),await d.Z.reloadNotes(t,!0)}(),await r.default.triggerEvent("treeCacheReloaded"),r.default.triggerEvent("protectedSessionStarted"),null!==c&&(n.e(261).then(n.bind(n,261)).then(t=>t.close()),c.resolve(!0),c=null),i.default.showMessage("Protected session has been started.")):i.default.showError("Wrong password.",3e3)}}},40:(t,e,n)=>{"use strict";n.d(e,{Z:()=>h});var o=n(46),s=n(378);let i=0;function a(t){o.Z.setSessionCookie("protectedSessionId",t)}function r(){o.Z.setSessionCookie("protectedSessionId",null),o.Z.reloadApp()}function d(){return!!o.Z.getCookie("protectedSessionId")}function c(){d()&&(i=Date.now(),a(o.Z.getCookie("protectedSessionId")))}setInterval(()=>{const t=s.Z.getInt("protectedSessionTimeout");i&&Date.now()-i>1e3*t&&r()},5e3);const h={setProtectedSessionId:a,resetProtectedSession:r,isProtectedSessionAvailable:d,touchProtectedSession:c,touchProtectedSessionIfNecessary:function(t){t&&t.isProtected&&d()&&c()}}},9:(t,e,n)=>{"use strict";n.d(e,{Z:()=>x});var o=n(481),s=n(800),i=n(46),a=n(885),r=n(985),d=n(806);async function c(){const t=$(this);if(t.hasClass("no-tooltip-preview")||t.hasClass("disabled")||"note-revision"===t.attr("data-action"))return;if(t.closest(".ck-link-actions").length)return;let e=r.Z.getNotePathFromUrl(t.attr("href"));if(e||(e=t.attr("data-note-path")),!e)return;const n=o.Z.getNoteIdFromNotePath(e),s=await d.Z.getNote(n),a=await d.Z.getNoteComplement(n),c=await async function(t,e){if(t.isDeleted)return"<div>Note has been deleted.</div>";const n=t.getAttributes();let o="";const s=n.filter(t=>"label-definition"===t.type||"relation-definition"===t.type).filter(t=>!t.name.startsWith("child:")).filter(t=>{const e=t.jsonValue;return e&&e.isPromoted});if(s.length>0){const t=$("<table>").addClass("promoted-attributes-in-tooltip");for(const e of s){const o=e.type,s=o.substr(0,o.length-11);let i=n.filter(t=>t.name===e.name&&t.type===s);for(const n of i){if(!n.value)continue;let o="";"label"===s?o=$("<td>").text(n.value):"relation"===s&&n.value&&(o=$("<td>").append(await r.Z.createNoteLink(n.value)));const i=$("<tr>").append($("<th>").text(e.name)).append(o);t.append(i)}}o+=t.prop("outerHTML")}"text"!==t.type||i.Z.isHtmlEmpty(e.content)?"code"===t.type&&e.content&&e.content.trim()?o+=$("<pre>").text(e.content).prop("outerHTML"):"image"===t.type&&(o+=$("<img>").prop("src",`api/images/${t.noteId}/${t.title}`).prop("outerHTML")):o+='<div class="ck-content">'+e.content+"</div>";return o}(s,a);$(this).is(":hover")&&($(this).tooltip({delay:{show:300,hide:100},container:"body",placement:"auto",trigger:"manual",boundary:"window",title:c,html:!0,template:'<div class="tooltip note-tooltip" role="tooltip"><div class="arrow"></div><div class="tooltip-inner"></div></div>',sanitize:!1}),$(this).tooltip("show"))}function h(){$(this).tooltip("dispose")}const l=function(t){t.on("mouseenter",c),t.on("mouseleave",h)};var u=n(336),g=n(383),p=n(221);class b extends p.Z{constructor(){super(),this.attrs={style:""},this.classes=[]}id(t){return this.attrs.id=t,this}class(t){return this.classes.push(t),this}css(t,e){return this.attrs.style+=`${t}: ${e};`,this}collapsible(){return this.css("min-height","0"),this}filling(){return this.css("flex-grow","1"),this}hideInZenMode(){return this.class("hide-in-zen-mode"),this}cssBlock(t){return this.cssEl=t,this}render(){const t=this.doRender();if(t.addClass("component").prop("component",this),this.toggleInt(this.isEnabled()),this.cssEl){const e=this.cssEl.trim().startsWith("<style>")?this.cssEl:`<style>${this.cssEl}</style>`;t.append(e)}for(const e in this.attrs)if("style"===e){if(this.attrs[e]){let n=t.attr("style");n=n?`${n}; ${this.attrs[e]}`:this.attrs[e],t.attr(e,n)}}else t.attr(e,this.attrs[e]);for(const e of this.classes)t.addClass(e);return t}isEnabled(){return!0}doRender(){}toggleInt(t){this.$widget.toggleClass("hidden-int",!t)}toggleExt(t){this.$widget.toggleClass("hidden-ext",!t)}isVisible(){return this.$widget.is(":visible")}getPosition(){return this.position}remove(){this.$widget&&this.$widget.remove()}cleanup(){}}const f=b;var w=n(95);class m extends f{isTab(t){return this.tabContext&&this.tabContext.tabId===t}isNote(t){return this.noteId===t}get note(){return this.tabContext&&this.tabContext.note}get noteId(){return this.note&&this.note.noteId}get notePath(){return this.tabContext&&this.tabContext.notePath}isEnabled(){return!!this.note}async refresh(){if(this.isEnabled()){const t=Date.now();this.toggleInt(!0),await this.refreshWithNote(this.note,this.notePath);const e=Date.now();glob.PROFILING_LOG&&e-t>10&&console.log(`Refresh of ${this.componentId} took ${e-t}ms`)}else this.toggleInt(!1)}async refreshWithNote(t,e){}async tabNoteSwitchedEvent({tabContext:t,notePath:e}){t.notePath===e&&await this.noteSwitched()}async noteSwitched(){await this.refresh()}async activeTabChangedEvent({tabContext:t}){this.tabContext=t,await this.activeTabChanged()}async activeTabChanged(){await this.refresh()}async tabNoteSwitchedAndActivatedEvent({tabContext:t,notePath:e}){this.tabContext=t,this.notePath===e&&await this.refresh()}setTabContextEvent({tabContext:t}){this.tabContext=t}async noteTypeMimeChangedEvent({noteId:t}){this.isNote(t)&&await this.refresh()}async treeCacheReloadedEvent(){await this.refresh()}async lazyLoadedEvent(){this.tabContext||(this.tabContext=w.default.tabManager.getActiveTabContext()),await this.refresh()}}var I=n(378);class y extends m{get widgetTitle(){return"Untitled widget"}get headerActions(){return[]}get help(){return{}}doRender(){return this.$widget=$('\n<div class="card widget">\n    <div class="card-header">\n        <div>           \n            <button class="btn btn-sm widget-title" data-toggle="collapse" data-target="#[to be set]">\n                Collapsible Group Item\n            </button>\n            \n            <a class="widget-help external no-arrow bx bx-info-circle"></a>\n        </div>\n        \n        <div class="widget-header-actions"></div>\n    </div>\n\n    <div id="[to be set]" class="collapse body-wrapper" style="transition: none; ">\n        <div class="card-body"></div>\n    </div>\n</div>'),this.$widget.find("[data-target]").attr("data-target","#"+this.componentId),this.$bodyWrapper=this.$widget.find(".body-wrapper"),this.$bodyWrapper.attr("id",this.componentId),this.widgetName=this.widgetTitle.replace(/[^[a-zA-Z0-9]/g,"_"),I.Z.is(this.widgetName+"Collapsed")||this.$bodyWrapper.collapse("show"),this.$bodyWrapper.on("hide.bs.collapse",()=>this.saveCollapsed(!0)),this.$bodyWrapper.on("show.bs.collapse",()=>this.saveCollapsed(!1)),this.$body=this.$bodyWrapper.find(".card-body"),this.$title=this.$widget.find(".widget-title"),this.$title.text(this.widgetTitle),this.$help=this.$widget.find(".widget-help"),this.help.title?(this.$help.attr("title",this.help.title),this.$help.attr("href",this.help.url||"javascript:"),this.help.url||this.$help.addClass("no-link")):this.$help.hide(),this.$headerActions=this.$widget.find(".widget-header-actions"),this.$headerActions.append(...this.headerActions),this.initialized=this.doRenderBody(),this.decorateWidget(),this.$widget}saveCollapsed(t){I.Z.save(this.widgetName+"Collapsed",t.toString()),this.triggerEvent("widgetCollapsedStateChanged",{widgetName:this.widgetName,collapse:t})}widgetCollapsedStateChangedEvent({widgetName:t,collapse:e}){t===this.widgetName&&this.$bodyWrapper.toggleClass("show",!e)}decorateWidget(){}async doRenderBody(){}isExpanded(){return this.$bodyWrapper.hasClass("show")}}var v=n(520),N=n(968),C=n(604);class Z extends m{constructor(t){super(),this.widgetFactory=t,this.widgets={}}doRender(){return this.$widget=$('<div class="marker" style="display: none;">')}async newTabOpenedEvent({tabContext:t}){const{tabId:e}=t;if(this.widgets[e])return;this.widgets[e]=this.widgetFactory();const n=this.widgets[e].render();this.widgets[e].toggleExt(!1),this.$widget.after(n),C.default.updateDisplayedShortcuts(n),await this.widgets[e].handleEvent("setTabContext",{tabContext:t}),this.child(this.widgets[e])}tabRemovedEvent({tabId:t}){const e=this.widgets[t];e&&(e.remove(),delete this.widgets[t],this.children=this.children.filter(t=>t!==e))}async refresh(){this.toggleExt(!0)}toggleInt(t){}toggleExt(t){for(const e in this.widgets)this.widgets[e].toggleExt(t&&this.isTab(e))}handleEventInChildren(t,e){if(["tabNoteSwitched","tabNoteSwitchedAndActivated"].includes(t)){const n=this.widgets[e.tabContext.tabId];return n&&(n.hasBeenAlreadyShown||"tabNoteSwitchedAndActivated"===t)?(n.hasBeenAlreadyShown=!0,n.handleEvent("tabNoteSwitched",e)):Promise.resolve()}if("activeTabChanged"===t){const n=this.widgets[e.tabContext.tabId];return n.hasBeenAlreadyShown?Promise.resolve():(n.hasBeenAlreadyShown=!0,n.handleEvent(t,e))}return super.handleEventInChildren(t,e)}}const T=function(t,e,n=null,o=null){const c=$("#plugin-buttons");function h(t){return t?t.map(t=>"function"==typeof t?"!@#Function: "+t.toString():t):t}this.$container=o,this.startNote=t,this.currentNote=e,this.originEntity=n,this.dayjs=dayjs,this.CollapsibleWidget=y,this.TabAwareWidget=m,this.TabCachingWidget=Z,this.BasicWidget=f,this.activateNote=async t=>{await w.default.tabManager.getActiveTabContext().setNote(t)},this.activateNewNote=async t=>{await v.Z.waitForMaxKnownSyncId(),await w.default.tabManager.getActiveTabContext().setNote(t),w.default.triggerEvent("focusAndSelectTitle")},this.addButtonToToolbar=t=>{const e="toolbar-button-"+t.title.replace(/[^a-zA-Z0-9]/g,"-"),n=$("<button>").addClass("btn btn-sm").on("click",t.action);t.icon&&n.append($("<span>").addClass("bx bx-"+t.icon)).append("&nbsp;"),n.append($("<span>").text(t.title)),n.attr("id",e),0===$("#"+e).replaceWith(n).length&&c.append(n),t.shortcut&&(i.Z.bindGlobalShortcut(t.shortcut,t.action),n.attr("title","Shortcut "+t.shortcut))},this.runOnBackend=async(o,i=[])=>{"function"==typeof o&&(o=o.toString());const a=await s.Z.post("script/exec",{script:o,params:h(i),startNoteId:t.noteId,currentNoteId:e.noteId,originEntityName:"notes",originEntityId:n?n.noteId:null},"script");if(a.success)return await v.Z.waitForSyncId(a.maxSyncId),a.executionResult;throw new Error("server error: "+a.error)},this.runOnServer=this.runOnBackend,this.searchForNotes=async t=>{const e=await this.runOnServer(async t=>(await api.searchForNotes(t)).map(t=>t.noteId),[t]);return await d.Z.getNotes(e)},this.searchForNote=async t=>{const e=await this.searchForNotes(t);return e.length>0?e[0]:null},this.getNote=async t=>await d.Z.getNote(t),this.getNotes=async(t,e=!1)=>await d.Z.getNotes(t,e),this.reloadNotes=async t=>await d.Z.reloadNotes(t),this.getInstanceName=()=>window.glob.instanceName,this.formatDateISO=i.Z.formatDateISO,this.parseDate=i.Z.parseDate,this.showMessage=a.default.showMessage,this.showError=a.default.showError,this.refreshTree=()=>{},this.createNoteLink=r.Z.createNoteLink,this.addTextToActiveTabEditor=t=>w.default.triggerCommand("addTextToActiveEditor",{text:t}),this.getActiveTabNote=()=>w.default.tabManager.getActiveTabNote(),this.getActiveTabTextEditor=t=>w.default.triggerCommand("executeInActiveEditor",{callback:t}),this.getActiveTabNotePath=()=>w.default.tabManager.getActiveTabNotePath(),this.setupElementTooltip=l,this.protectActiveNote=async()=>{const t=w.default.tabManager.getActiveTabNote();await u.Z.protectNote(t.noteId,!0,!1)},this.protectNote=async(t,e)=>{await u.Z.protectNote(t,e,!1)},this.protectSubTree=async(t,e)=>{await u.Z.protectNote(t,e,!0)},this.getTodayNote=g.Z.getTodayNote,this.getDateNote=g.Z.getDateNote,this.getMonthNote=g.Z.getMonthNote,this.getYearNote=g.Z.getYearNote,this.setHoistedNoteId=N.Z.setHoistedNoteId,this.bindGlobalShortcut=i.Z.bindGlobalShortcut,this.waitUntilSynced=v.Z.waitForMaxKnownSyncId,this.refreshIncludedNote=t=>w.default.triggerEvent("refreshIncludedNote",{noteId:t})};const x=async function(t,e,n=null,o=null){const s={};await d.Z.initializedPromise;const a=await d.Z.getNote(t),r=await d.Z.getNotes(e);return{modules:s,notes:i.Z.toObject(r,t=>[t.noteId,t]),apis:i.Z.toObject(r,t=>[t.noteId,new T(a,t,n,o)]),require:t=>e=>{const n=r.filter(e=>t.includes(e.noteId)).find(t=>t.title===e);if(!n)throw new Error("Could not find module note "+e);return s[n.noteId].exports}}}},800:(t,e,n)=>{"use strict";n.d(e,{Z:()=>h});var o=n(46);function s(t){const e={"trilium-source-id":glob.sourceId,"trilium-local-now-datetime":o.Z.localNowDateTime(),"x-csrf-token":glob.csrfToken};for(const n in t)t[n]&&(e[n]=t[n]);return o.Z.isElectron()&&(e.cookie=document.cookie),e}let i=1;const a={};let r=0;async function d(t,e,n,d={}){let h;const l=Date.now();if(o.Z.isElectron()){const r=o.Z.dynamicRequire("electron").ipcRenderer,c=i++;h=await new Promise((o,i)=>{a[c]=o,r.send("server-request",{requestId:c,headers:s(d),method:t,url:"/"+baseApiUrl+e,data:n})})}else h=await c(e,t,n,d);const u=Date.now();glob.PROFILING_LOG&&console.log(`${t} ${e} took ${u-l}ms`);const g=h.headers["trilium-max-sync-id"];return g&&g.trim()&&(r=Math.max(r,parseInt(g))),h.body}function c(t,e,o,i){return new Promise((a,r)=>{const d={url:baseApiUrl+t,type:e,headers:s(i),timeout:6e4,success:(t,e,n)=>{const o={};n.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach(t=>{const e=t.split(": "),n=e.shift();o[n]=e.join(": ")}),a({body:t,headers:o})},error:async(o,s,i)=>{const a="Error when calling "+e+" "+t+": "+s+" - "+i,d=(await Promise.resolve().then(n.bind(n,885))).default;d.showError(a),d.throwError(a),r(i)}};if(o){try{d.data=JSON.stringify(o)}catch(t){console.log("Can't stringify data: ",o," because of error: ",t)}d.contentType="application/json"}$.ajax(d)})}if(o.Z.isElectron()){o.Z.dynamicRequire("electron").ipcRenderer.on("server-response",(t,e)=>{a[e.requestId]({body:e.body,headers:e.headers}),delete a[e.requestId]})}const h={get:async function(t,e){return await d("GET",t,null,{"trilium-source-id":e})},post:async function(t,e,n){return await d("POST",t,e,{"trilium-source-id":n})},put:async function(t,e,n){return await d("PUT",t,e,{"trilium-source-id":n})},remove:async function(t,e){return await d("DELETE",t,null,{"trilium-source-id":e})},ajax:c,getHeaders:s,getMaxKnownSyncId:()=>r}},885:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>r});var o=n(520),s=n(46);function i(t){const e=$(`<div class="toast" role="alert" aria-live="assertive" aria-atomic="true">\n    <div class="toast-header">\n        <strong class="mr-auto"><span class="bx bx-${t.icon}"></span> ${t.title}</strong>\n        <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">\n            <span aria-hidden="true">&times;</span>\n        </button>\n    </div>\n    <div class="toast-body">\n        ${t.message}\n    </div>\n</div>`);return t.id&&e.attr("id","toast-"+t.id),$("#toast-container").append(e),e.toast({delay:t.delay||3e3,autohide:!!t.autohide}),e.on("hidden.bs.toast",t=>t.target.remove()),e.toast("show"),e}function a(t,e=1e4){console.log(s.Z.now(),"error: ",t),i({title:"Error",icon:"alert",message:t,autohide:!0,delay:e})}const r={showMessage:function(t,e=2e3){console.debug(s.Z.now(),"message: ",t),i({title:"Info",icon:"check",message:t,autohide:!0,delay:e})},showError:a,showAndLogError:function(t,e=1e4){a(t,e),o.Z.logError(t)},throwError:function(t){throw o.Z.logError(t),new Error(t)},showPersistent:function(t){let e=$("#toast-"+t.id);e.length>0?e.find(".toast-body").html(t.message):(t.autohide=!1,e=i(t)),t.closeAfter&&setTimeout(()=>e.remove(),t.closeAfter)},closePersistent:function(t){$("#toast-"+t).remove()}}},481:(t,e,n)=>{"use strict";n.d(e,{Z:()=>u});var o=n(520),s=n(46),i=n(800),a=n(806),r=n(968),d=n(95);async function c(t,e=!0){if(s.Z.assertArguments(t),0===(t=t.split("-")[0].trim()).length)return;const n=t.split("/").reverse();n.includes("root")||n.push("root");const i=r.Z.getHoistedNoteId(),d=[];let c=null,l=0;for(;!(l>=n.length);){const t=n[l++];if(null!==c){const n=await a.Z.getNote(c);if(!n)return void console.log("Can't find note "+c);const i=n.getParentNotes();if(!i)return void o.Z.logError("No parents found for "+c);if(!i.some(e=>e.noteId===t)){if(e&&console.log(s.Z.now(),"Did not find parent "+t+" for child "+c),i.length>0){e&&console.log(s.Z.now(),"Available parents:",i);const t=await h(i[0]);if(t){const e=t.split("/").reverse();for(const t of e)d.push(t);d.push("root")}break}return void(e&&console.log("No parents so no run path."))}}if(d.push(t),c=t,t===i)break}return d.reverse()}async function h(t){s.Z.assertArguments(t);const e=[];let n=t;for(;"root"!==n.noteId;){e.push(n.noteId);const t=n.getParentNotes();if(!t.length)return void console.error("Can't find parents for note "+n.noteId);n=t[0]}return e.push("root"),e.reverse().join("/")}async function l(t,e=null){s.Z.assertArguments(t);const n=await a.Z.getNote(t);if(!n)return"[not found]";let{title:o}=n;if(null!==e){const t=n.parentToBranch[e];if(t){const e=a.Z.getBranch(t);e&&e.prefix&&(o=e.prefix+" - "+o)}}return o}o.Z.subscribeToMessages(t=>{if("open-note"===t.type&&(d.default.tabManager.activateOrOpenNote(t.noteId),s.Z.isElectron())){s.Z.dynamicRequire("electron").remote.getCurrentWindow().show()}});const u={sortAlphabetically:async function(t){await i.Z.put("notes/"+t+"/sort")},resolveNotePath:async function(t){const e=await c(t);return e?e.join("/"):null},getSomeNotePath:h,getRunPath:c,getParentProtectedStatus:function(t){return r.Z.isRootNode(t)?0:t.getParent().data.isProtected},getNotePath:function(t){if(!t)return console.error("Node is null"),"";const e=[];for(;t&&!r.Z.isRootNode(t);)t.data.noteId&&e.push(t.data.noteId),t=t.getParent();return t&&e.push(t.data.noteId),e.reverse().join("/")},getNoteIdFromNotePath:function(t){if(!t)return null;const e=t.split("/");return e[e.length-1].split("-")[0]},getNoteIdAndParentIdFromNotePath:function(t){if("root"===t)return{noteId:"root",parentNoteId:"none"};let e="root",n="";if(t){const o=t.split("/");n=o[o.length-1].split("-")[0],o.length>1&&(e=o[o.length-2])}return{parentNoteId:e,noteId:n}},getNoteTitle:l,getNotePathTitle:async function(t){s.Z.assertArguments(t);const e=[];if(t.startsWith("root/")&&(t=t.substr(5)),"root"===t)return await l(t);let n="root";for(const o of t.split("/"))e.push(await l(o,n)),n=o;return e.join(" / ")},getHashValueFromAddress:function(){return(document.location.hash?document.location.hash.substr(1):"").split("-")},parseNotePath:function(t){let e=t.split("/");return"root"!==e[0]&&(e=["root"].concat(e)),e}}},806:(t,e,n)=>{"use strict";n.d(e,{Z:()=>h});var o=n(215),s=n(800),i=n(708),a=n(342);const r="label";const d=class{constructor(t,e){this.treeCache=t,this.attributes=[],this.targetRelations=[],this.parents=[],this.children=[],this.parentToBranch={},this.childToBranch={},this.update(e)}update(t){this.noteId=t.noteId,this.title=t.title,this.contentLength=t.contentLength,this.isProtected=!!t.isProtected,this.type=t.type,this.mime=t.mime,this.isDeleted=t.isDeleted}addParent(t,e){this.parents.includes(t)||this.parents.push(t),this.parentToBranch[t]=e}addChild(t,e){this.children.includes(t)||this.children.push(t),this.childToBranch[t]=e;const n={};for(const t of Object.values(this.childToBranch))n[t]=this.treeCache.getBranch(t).notePosition;this.children.sort((t,e)=>n[this.childToBranch[t]]<n[this.childToBranch[e]]?-1:1)}isJson(){return"application/json"===this.mime}async getContent(){return(await s.Z.get("notes/"+this.noteId)).content}async getJsonContent(){const t=await this.getContent();try{return JSON.parse(t)}catch(t){return console.log(`Cannot parse content of note ${this.noteId}: `,t.message),null}}getBranchIds(){return Object.values(this.parentToBranch)}getBranches(){const t=Object.values(this.parentToBranch);return this.treeCache.getBranches(t)}hasChildren(){return this.children.length>0}getChildBranches(){const t=this.children.map(t=>this.childToBranch[t]);return this.treeCache.getBranches(t)}getParentNoteIds(){return this.parents}getParentNotes(){return this.treeCache.getNotesFromCache(this.parents)}getChildNoteIds(){return this.children}async getChildNotes(){return await this.treeCache.getNotes(this.children)}getOwnedAttributes(t,e){const n=this.attributes.map(t=>this.treeCache.attributes[t]).filter(Boolean);return this.__filterAttrs(n,t,e)}getAttributes(t,e){return this.__filterAttrs(this.__getCachedAttributes([]),t,e)}__getCachedAttributes(t){if(t.includes(this.noteId))return[];if(!(this.noteId in a.Z)){const e=this.getOwnedAttributes(),n=[e],o=[...t,this.noteId];for(const t of e.filter(t=>"relation"===t.type&&"template"===t.name)){const e=this.treeCache.notes[t.value];e&&e.noteId!==this.noteId&&n.push(e.__getCachedAttributes(o))}if("root"!==this.noteId)for(const t of this.getParentNotes())"search"!==t.type&&n.push(t.__getInheritableAttributes(o));a.Z.attributes[this.noteId]=n.flat()}return a.Z.attributes[this.noteId]}__filterAttrs(t,e,n){return e||n?e&&n?t.filter(t=>t.type===e&&t.name===n):e?t.filter(t=>t.type===e):n?t.filter(t=>t.name===n):void 0:t}__getInheritableAttributes(t){return this.__getCachedAttributes(t).filter(t=>t.isInheritable)}getOwnedLabels(t){return this.getOwnedAttributes(r,t)}getLabels(t){return this.getAttributes(r,t)}getLabelDefinitions(t){return this.getAttributes("label-definition",t)}getOwnedRelations(t){return this.getOwnedAttributes("relation",t)}getRelations(t){return this.getAttributes("relation",t)}getRelationDefinitions(t){return this.getAttributes("relation-definition",t)}hasAttribute(t,e){return!!this.getAttribute(t,e)}hasOwnedAttribute(t,e){return!!this.getOwnedAttribute(t,e)}getOwnedAttribute(t,e){const n=this.getOwnedAttributes(t,e);return n.length>0?n[0]:0}getAttribute(t,e){const n=this.getAttributes(t,e);return n.length>0?n[0]:0}getOwnedAttributeValue(t,e){const n=this.getOwnedAttribute(t,e);return n?n.value:null}getAttributeValue(t,e){const n=this.getAttribute(t,e);return n?n.value:null}hasOwnedLabel(t){return this.hasOwnedAttribute(r,t)}hasLabel(t){return this.hasAttribute(r,t)}hasOwnedRelation(t){return this.hasOwnedAttribute("relation",t)}hasRelation(t){return this.hasAttribute("relation",t)}getOwnedLabel(t){return this.getOwnedAttribute(r,t)}getLabel(t){return this.getAttribute(r,t)}getOwnedRelation(t){return this.getOwnedAttribute("relation",t)}getRelation(t){return this.getAttribute("relation",t)}getOwnedLabelValue(t){return this.getOwnedAttributeValue(r,t)}getLabelValue(t){return this.getAttributeValue(r,t)}getOwnedRelationValue(t){return this.getOwnedAttributeValue("relation",t)}getRelationValue(t){return this.getAttributeValue("relation",t)}async getRelationTarget(t){const e=await this.getRelationTargets(t);return e.length>0?e[0]:null}async getRelationTargets(t){const e=this.getRelations(t),n=[];for(const t of e)n.push(await this.treeCache.getNote(t.value));return n}getTemplateNotes(){return this.getRelations("template").map(t=>this.treeCache.notes[t.value])}hasAncestor(t){if(this.noteId===t.noteId)return!0;for(const e of this.getTemplateNotes())if(e.hasAncestor(t))return!0;for(const e of this.getParentNotes())if(e.hasAncestor(t))return console.log(e),!0;return!1}invalidateAttributeCache(){this.__attributeCache=null}getTargetRelations(){return this.targetRelations.map(t=>this.treeCache.attributes[t])}async getNoteComplement(){return await this.treeCache.getNoteComplement(this.noteId)}get toString(){return`Note(noteId=${this.noteId}, title=${this.title})`}get dto(){const t=Object.assign({},this);return delete t.treeCache,t}getCssClass(){return this.getLabels("cssClass").map(t=>t.value).join(" ")}};const c=class{constructor(t){this.noteId=t.noteId,this.content=t.content,this.dateCreated=t.dateCreated,this.dateModified=t.dateModified,this.utcDateCreated=t.utcDateCreated,this.utcDateModified=t.utcDateModified}};const h=new class{constructor(){this.initializedPromise=this.loadInitialTree()}async loadInitialTree(){const t=await s.Z.get("tree");await this.loadParents(t,!1),this.notes={},this.branches={},this.attributes={},this.noteComplementPromises={},this.addResp(t)}async loadParents(t,e){const n=new Set(t.notes.map(t=>t.noteId)),o=[],i=e?this.notes:{};for(const e of t.branches)e.parentNoteId in i||n.has(e.parentNoteId)||"none"===e.parentNoteId||o.push(e.parentNoteId);for(const e of t.attributes)"relation"!==e.type||"template"!==e.name||e.value in i||n.has(e.value)||o.push(e.value),e.noteId in i||n.has(e.noteId)||o.push(e.noteId);if(o.length>0){const n=await s.Z.post("tree/load",{noteIds:o});t.notes=t.notes.concat(n.notes),t.branches=t.branches.concat(n.branches),t.attributes=t.attributes.concat(n.attributes),await this.loadParents(t,e)}}addResp(t){const e=t.notes,n=t.branches,s=t.attributes;for(const t of e){const{noteId:e}=t,n=this.notes[e];if(n){for(const t of n.children){const n=this.notes[t];n&&(n.parents=n.parents.filter(t=>t!==e),delete this.branches[n.parentToBranch[e]],delete n.parentToBranch[e])}for(const t of n.parents){const n=this.notes[t];n&&(n.children=n.children.filter(t=>t!==e),delete this.branches[n.childToBranch[e]],delete n.childToBranch[e])}}const o=new d(this,t);this.notes[o.noteId]=o}for(const t of n){const e=new o.Z(this,t);this.branches[e.branchId]=e;const n=this.notes[e.noteId];n&&n.addParent(e.parentNoteId,e.branchId);const s=this.notes[e.parentNoteId];s&&s.addChild(e.noteId,e.branchId)}for(const t of s){const{attributeId:e}=t;this.attributes[e]=new i.Z(this,t);const n=this.notes[t.noteId];if(n.attributes.includes(e)||n.attributes.push(e),"relation"===t.type){const n=this.notes[t.value];n&&(n.targetRelations.includes(e)||n.targetRelations.push(e))}}}async reloadNotes(t){if(0===t.length)return;t=Array.from(new Set(t));const e=await s.Z.post("tree/load",{noteIds:t});await this.loadParents(e,!0),this.addResp(e);for(const t of e.notes)if("search"===t.type){const n=await s.Z.get("search-note/"+t.noteId);if(!n)throw new Error(`Search note ${t.noteId} failed.`);await this.getNotes(n.map(t=>t.noteId));const o=e.branches.filter(e=>e.noteId===t.noteId||e.parentNoteId===t.noteId);n.forEach((e,n)=>o.push({branchId:"virt"+e.noteId+"-"+t.noteId,noteId:e.noteId,parentNoteId:t.noteId,prefix:this.getBranch(e.branchId).prefix,notePosition:10*(n+1)})),this.addResp({notes:[t],branches:o,attributes:[]})}}getNotesFromCache(t,e=!1){return t.map(t=>this.notes[t]||e?this.notes[t]:(console.log(`Can't find note "${t}"`),null)).filter(t=>!!t)}async getNotes(t,e=!1){const n=t.filter(t=>!this.notes[t]);return await this.reloadNotes(n),t.map(t=>this.notes[t]||e?this.notes[t]:(console.log(`Can't find note "${t}"`),null)).filter(t=>!!t)}async noteExists(t){return 1===(await this.getNotes([t],!0)).length}async getNote(t,e=!1){return"none"===t?(console.trace("No 'none' note."),null):t?(await this.getNotes([t],e))[0]:(console.log(`Falsy noteId ${t}, returning null.`),null)}getNoteFromCache(t){return this.notes[t]}getBranches(t,e=!1){return t.map(t=>this.getBranch(t,e)).filter(t=>!!t)}getBranch(t,e=!1){if(t in this.branches)return this.branches[t];e||console.error("Not existing branch "+t)}async getBranchId(t,e){const n=await this.getNote(e);return n?n.parentToBranch[t]:(console.error(`Could not find branchId for parent=${t}, child=${e} since child does not exist`),null)}async getNoteComplement(t){return this.noteComplementPromises[t]||(this.noteComplementPromises[t]=s.Z.get("notes/"+t).then(t=>new c(t))),await this.noteComplementPromises[t]}}},520:(t,e,n)=>{"use strict";n.d(e,{Z:()=>A});var o=n(46),s=n(885),i=n(800);class a{constructor(t){this.treeCache=t,this.noteIdToSourceId={},this.sourceIdToNoteIds={},this.branches=[],this.attributes=[],this.noteReorderings=[],this.noteRevisions=[],this.contentNoteIdToSourceId=[],this.options=[]}addNote(t,e){this.noteIdToSourceId[t]=this.noteIdToSourceId[t]||[],this.noteIdToSourceId[t].includes(e)||this.noteIdToSourceId[t].push(e),this.sourceIdToNoteIds[e]=this.sourceIdToNoteIds[e]||[],this.sourceIdToNoteIds[e]||this.sourceIdToNoteIds[e].push(t)}addBranch(t,e){this.branches.push({branchId:t,sourceId:e})}getBranches(){return this.branches.map(t=>this.treeCache.branches[t.branchId]).filter(t=>!!t)}addNoteReordering(t,e){this.noteReorderings.push(t)}getNoteReorderings(){return this.noteReorderings}addAttribute(t,e){this.attributes.push({attributeId:t,sourceId:e})}getAttributes(t="none"){return this.attributes.filter(e=>e.sourceId!==t).map(t=>this.treeCache.attributes[t.attributeId]).filter(t=>!!t)}addNoteRevision(t,e,n){this.noteRevisions.push({noteRevisionId:t,noteId:e,sourceId:n})}hasNoteRevisionForNote(t){return!!this.noteRevisions.find(e=>e.noteId===t)}getNoteIds(){return Object.keys(this.noteIdToSourceId)}isNoteReloaded(t,e=null){if(!t)return!1;const n=this.noteIdToSourceId[t];return n&&!!n.find(t=>t!==e)}addNoteContent(t,e){this.contentNoteIdToSourceId.push({noteId:t,sourceId:e})}isNoteContentReloaded(t,e){return!!t&&this.contentNoteIdToSourceId.find(n=>n.noteId===t&&n.sourceId!==e)}addOption(t){this.options.push(t)}isOptionReloaded(t){this.options.includes(t)}hasAttributeRelatedChanges(){return 0===this.branches.length&&0===this.attributes.length}isEmpty(){return 0===Object.keys(this.noteIdToSourceId).length&&0===this.branches.length&&0===this.attributes.length&&0===this.noteReorderings.length&&0===this.noteRevisions.length&&0===this.contentNoteIdToSourceId.length&&0===this.options.length}}var r=n(215),d=n(708),c=n(378),h=n(806),l=n(342);const u=$("#outstanding-syncs-count"),g=[];let p,b,f=window.glob.maxSyncIdAtLoad,w=window.glob.maxSyncIdAtLoad,m=[];function I(t){console.log(o.Z.now(),t),console.trace(),p&&1===p.readyState&&p.send(JSON.stringify({type:"log-error",error:t,stack:(new Error).stack}))}function y(t){g.push(t)}let v=null;const N=new Set;async function C(t){const e=JSON.parse(t.data);for(const t of g)t(e);if("sync"===e.type){let t=e.data;if(b=Date.now(),u.html(e.outstandingSyncs),t.length>0){for(!function(t){const e=t.filter(t=>!N.has(t.id)&&"recent_notes"!==t.entityName&&("options"!==t.entityName||"openTabs"!==t.entityId));e.length>0&&console.debug(o.Z.now(),"Sync data: ",e)}(t),m.push(...t),f=Math.max(f,t[t.length-1].id),P();v;)await v;try{v=async function(){if(m.length>0){const t=m;m=[];const e=t.filter(t=>!N.has(t.id));try{await o.Z.timeLimit(async function(t){const e=[];for(const{entityName:n,entity:o}of t)"branches"!==n||o.parentNoteId in h.Z.notes?"attributes"!==n||"relation"!==o.type||"template"!==o.name||o.noteId in h.Z.notes||e.push(o.value):e.push(o.parentNoteId);e.length>0&&await h.Z.reloadNotes(e);const o=new a(h.Z);for(const e of t.filter(t=>"notes"===t.entityName)){const t=h.Z.notes[e.entityId];t&&(t.update(e.entity),o.addNote(e.entityId,e.sourceId))}for(const e of t.filter(t=>"branches"===t.entityName)){let t=h.Z.branches[e.entityId];const n=h.Z.notes[e.entity.noteId],s=h.Z.notes[e.entity.parentNoteId];t?(t.update(e.entity),o.addBranch(e.entityId,e.sourceId),e.entity.isDeleted?(n&&(n.parents=n.parents.filter(t=>t!==e.entity.parentNoteId),delete n.parentToBranch[e.entity.parentNoteId]),s&&(s.children=s.children.filter(t=>t!==e.entity.noteId),delete s.childToBranch[e.entity.noteId])):(n&&n.addParent(t.parentNoteId,t.branchId),s&&s.addChild(t.noteId,t.branchId))):e.entity.isDeleted||(n||s)&&(t=new r.Z(h.Z,e.entity),h.Z.branches[t.branchId]=t,o.addBranch(e.entityId,e.sourceId),n&&n.addParent(t.parentNoteId,t.branchId),s&&s.addChild(t.noteId,t.branchId))}for(const e of t.filter(t=>"note_reordering"===t.entityName)){for(const t in e.positions){const n=h.Z.branches[t];n&&(n.notePosition=e.positions[t])}o.addNoteReordering(e.entityId,e.sourceId)}for(const e of t.filter(t=>"attributes"===t.entityName)){let t=h.Z.attributes[e.entityId];const n=h.Z.notes[e.entity.noteId],s="relation"===e.entity.type&&h.Z.notes[e.entity.value];t?(t.update(e.entity),o.addAttribute(e.entityId,e.sourceId),e.entity.isDeleted&&(n&&(n.attributes=n.attributes.filter(e=>e!==t.attributeId)),s&&(s.targetRelations=s.targetRelations.filter(e=>e!==t.attributeId)))):e.entity.isDeleted||(n||s)&&(t=new d.Z(h.Z,e.entity),h.Z.attributes[t.attributeId]=t,o.addAttribute(e.entityId,e.sourceId),n&&!n.attributes.includes(t.attributeId)&&n.attributes.push(t.attributeId),s&&!s.targetRelations.includes(t.attributeId)&&s.targetRelations.push(t.attributeId))}for(const e of t.filter(t=>"note_contents"===t.entityName))delete h.Z.noteComplementPromises[e.entityId],o.addNoteContent(e.entityId,e.sourceId);for(const e of t.filter(t=>"note_revisions"===t.entityName))o.addNoteRevision(e.entityId,e.noteId,e.sourceId);for(const e of t.filter(t=>"options"===t.entityName))"openTabs"!==e.entity.name&&(c.Z.set(e.entity.name,e.entity.value),o.addOption(e.entity.name));if(!o.isEmpty()){o.hasAttributeRelatedChanges()&&l.Z.invalidate();const t=(await Promise.resolve().then(n.bind(n,95))).default;await t.triggerEvent("entitiesReloaded",{loadResults:o})}}(e),5e3)}catch(t){I(`Encountered error ${t.message}: ${t.stack}, reloading frontend.`),o.Z.reloadApp()}for(const t of e)N.add(t.id);w=Math.max(w,t[t.length-1].id)}Z.filter(t=>t.desiredSyncId<=w).forEach(t=>t.resolvePromise()),Z=Z.filter(t=>t.desiredSyncId>w),Z.filter(t=>Date.now()>t.start-6e4).forEach(t=>console.log(`Waiting for syncId ${t.desiredSyncId} while current is ${w} for ${Math.floor((Date.now()-t.start)/1e3)}s`))}(),await v}finally{v=null}}}else"sync-hash-check-failed"===e.type?s.default.showError("Sync check failed!",6e4):"consistency-checks-failed"===e.type&&s.default.showError("Consistency checks failed! See logs for details.",3e6)}let Z=[];function T(t){return t<=w?Promise.resolve():(console.debug("Waiting for",t,"current is",w),new Promise((e,n)=>{Z.push({desiredSyncId:t,resolvePromise:e,start:Date.now()})}))}function x(){const t=window.location,e=("https:"===t.protocol?"wss:":"ws:")+"//"+t.host+t.pathname,n=new WebSocket(e);return n.onopen=()=>console.debug(o.Z.now(),`Connected to server ${e} with WebSocket`),n.onmessage=C,n}async function P(){Date.now()-b>3e4&&console.log(o.Z.now(),"Lost websocket connection to the backend. If you keep having this issue repeatedly, you might want to check your reverse proxy (nginx, apache) configuration and allow/unblock WebSocket."),p.readyState===p.OPEN?p.send(JSON.stringify({type:"ping",lastSyncId:f})):p.readyState!==p.CLOSED&&p.readyState!==p.CLOSING||(console.log(o.Z.now(),"WS closed or closing, trying to reconnect"),p=x())}setTimeout(()=>{p=x(),b=Date.now(),setInterval(P,1e3)},0),y(t=>{"sync-pull-in-progress"===t.type?s.default.showPersistent({id:"sync",title:"Sync status",message:"Sync update in progress",icon:"refresh"}):"sync-pull-finished"===t.type&&setTimeout(()=>s.default.closePersistent("sync"),1e3)});const A={logError:I,subscribeToMessages:y,waitForSyncId:T,waitForMaxKnownSyncId:function(){return T(i.Z.getMaxKnownSyncId())}}},221:(t,e,n)=>{"use strict";n.d(e,{Z:()=>s});var o=n(46);class s{constructor(){this.componentId="comp-"+o.Z.randomString(8),this.children=[],this.initialized=Promise.resolve()}setParent(t){return this.parent=t,this}child(...t){for(const e of t)e.setParent(this),this.children.push(e);return this}handleEvent(t,e){return Promise.all([this.initialized.then(()=>this.callMethod(this[t+"Event"],e)),this.handleEventInChildren(t,e)])}triggerEvent(t,e){return this.parent.triggerEvent(t,e)}handleEventInChildren(t,e){const n=[];for(const o of this.children)n.push(o.handleEvent(t,e));return Promise.all(n)}triggerCommand(t,e={}){const n=this[t+"Command"];return n?this.callMethod(n,e):this.parent.triggerCommand(t,e)}async callMethod(t,e){return"function"==typeof t&&(await t.call(this,e),!0)}}}}]);
//# sourceMappingURL=800.setup.js.map