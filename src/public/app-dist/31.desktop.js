(window.webpackJsonptrilium=window.webpackJsonptrilium||[]).push([[31],{6031:(t,e,i)=>{"use strict";i.r(e),i.d(e,{showDialog:()=>y});var a=i(9800),n=i(6885),l=i(8481),o=i(5819),u=i(9046),r=i(7844),s=i(6707),b=i(9847),d=i(8003);const c=$("#attributes-dialog"),p=$("#save-attributes-button"),f=$("#owned-attributes-table tbody");function g(){const t=this;async function e(e,a){const n=a.filter(t=>t.noteId===e);for(const t of n)t.labelValue="label"===t.type?t.value:"",t.relationValue="relation"===t.type?await l.Z.getNoteTitle(t.value):"",t.selectedPath="relation"===t.type?t.value:"",t.labelDefinition="label-definition"===t.type&&t.value?t.value:{labelType:"text",multiplicityType:"singlevalue",isPromoted:!0,numberPrecision:0},t.relationDefinition="relation-definition"===t.type&&t.value?t.value:{multiplicityType:"singlevalue",inverseRelation:"",isPromoted:!0},delete t.value;t.ownedAttributes(n.map(ko.observable)),i();const o=a.filter(t=>t.noteId!==e);t.inheritedAttributes(o)}function i(){const e=t.ownedAttributes().filter(t=>!t().isDeleted),i=0===e.length?null:e[e.length-1]();i&&""===i.name.trim()||t.ownedAttributes.push(ko.observable({attributeId:"",type:"label",name:"",labelValue:"",relationValue:"",isInheritable:!1,isDeleted:!1,position:0,labelDefinition:{labelType:"text",multiplicityType:"singlevalue",isPromoted:!0,numberPrecision:0},relationDefinition:{multiplicityType:"singlevalue",inverseRelation:"",isPromoted:!0}}))}this.ownedAttributes=ko.observableArray(),this.inheritedAttributes=ko.observableArray(),this.availableTypes=[{text:"Label",value:"label"},{text:"Label definition",value:"label-definition"},{text:"Relation",value:"relation"},{text:"Relation definition",value:"relation-definition"}],this.availableLabelTypes=[{text:"Text",value:"text"},{text:"Number",value:"number"},{text:"Boolean",value:"boolean"},{text:"Date",value:"date"},{text:"URL",value:"url"}],this.multiplicityTypes=[{text:"Single value",value:"singlevalue"},{text:"Multi value",value:"multivalue"}],this.typeChanged=function(e,i){t.getTargetAttribute(i.target).valueHasMutated()},this.labelTypeChanged=function(e,i){t.getTargetAttribute(i.target).valueHasMutated()},this.updateAttributePositions=function(){let e=10;f.find('input[name="position"]').each((function(){t.getTargetAttribute(this)().position=e,e+=10}))},this.loadAttributes=async function(){const t=d.default.tabManager.getActiveTabNoteId(),i=await a.Z.get("notes/"+t+"/attributes");await e(t,i),setTimeout(()=>$(".attribute-type-select:last").trigger("focus"),1e3)},this.deleteAttribute=function(e,a){const n=t.getTargetAttribute(a.target),l=n();l&&(l.isDeleted=!0,n(l),i())},this.save=async function(){if(p.trigger("focus"),!function(){for(let e=t.ownedAttributes(),i=0;i<e.length;i++)if(t.isEmptyName(i)||t.isEmptyRelationTarget(i))return!1;return!0}())return void alert("Please fix all validation errors and try saving again.");t.updateAttributePositions();const i=d.default.tabManager.getActiveTabNoteId(),o=t.ownedAttributes().map(t=>t()).filter(t=>""!==t.attributeId||""!==t.name);for(const t of o)"label"===t.type?t.value=t.labelValue:"relation"===t.type?t.value=l.Z.getNoteIdFromNotePath(t.selectedPath):"label-definition"===t.type?t.value=JSON.stringify(t.labelDefinition):"relation-definition"===t.type&&(t.value=JSON.stringify(t.relationDefinition)),delete t.labelValue,delete t.relationValue,delete t.labelDefinition,delete t.relationDefinition;const u=await a.Z.put("notes/"+i+"/attributes",o);await e(i,u),n.default.showMessage("Attributes have been saved.")},this.attributeChanged=function(e,a){i(),t.getTargetAttribute(a.target).valueHasMutated()},this.isEmptyName=function(e){const i=t.ownedAttributes()[e]();return!i.name.trim()&&!i.isDeleted&&(!!i.attributeId||("relation-definition"===i.type||"label-definition"===i.type||(!("label"!==i.type||!i.labelValue)||!("relation"!==i.type||!i.relationValue))))},this.isEmptyRelationTarget=function(e){const i=t.ownedAttributes()[e]();return"relation"===i.type&&!i.isDeleted&&i.name&&!i.relationValue},this.getTargetAttribute=function(e){const i=ko.contextFor(e).$index();return t.ownedAttributes()[i]}}let v;async function y(){await s.Z.requireLibrary(s.Z.KNOCKOUT),v||(v=new g,ko.bindingHandlers.noteLink={init:async function(t,e,i,a,n){const l=ko.unwrap(e());if(l){const e=await r.Z.createNoteLink(l);$(t).append(e)}}},ko.bindingHandlers.noteAutocomplete={init:function(t,e,i,a,n){b.Z.initNoteAutocomplete($(t)),$(t).setSelectedPath(n.$data.selectedPath),$(t).on("autocomplete:selected",(function(e,i,a){n.$data.selectedPath=$(t).val().trim()?i.path:""}))}},ko.applyBindings(v,c[0])),await v.loadAttributes(),u.Z.openDialog(c)}c.on("focus",".attribute-name",(function(t){o.Z.initAttributeNameAutocomplete({$el:$(this),attributeType:()=>{const t=v.getTargetAttribute(this);return"relation"===t().type||"relation-definition"===t().type?"relation":"label"},open:!0})})),c.on("focus",".label-value",(function(t){o.Z.initLabelValueAutocomplete({$el:$(this),open:!0})}))}}]);
//# sourceMappingURL=31.desktop.js.map