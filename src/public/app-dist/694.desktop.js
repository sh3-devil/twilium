(window.webpackJsonptrilium=window.webpackJsonptrilium||[]).push([[694,409],{1694:(t,n,e)=>{"use strict";e.r(n),e.d(n,{showDialog:()=>h});var o=e(9046),i=e(6409),s=e(8003);const a=$("#link-map-container"),r=$("#link-map-dialog"),l=$("#link-map-max-notes");let d;function c(){return{maxNotes:l.val()}}async function h(){l.val(20),a.css("height",$("body").height()-150),a.empty(),o.Z.openDialog(r)}r.on("shown.bs.modal",()=>{const t=s.default.tabManager.getActiveTabNote();d=new i.default(t,a,c()),d.render()}),l.on("input",()=>d.loadNotesAndRelations(c()))},6409:(t,n,e)=>{"use strict";e.r(n),e.d(n,{default:()=>l});var o=e(6707),i=e(9800),s=e(9806),a=e(7844);const r=[["Arrow",{location:1,id:"arrow",length:10,width:10,foldback:.7}]];class l{constructor(t,n,e={}){this.note=t,this.options=Object.assign({maxDepth:10,maxNotes:30,zoom:1,stopCheckerCallback:()=>!1},e),this.$linkMapContainer=n,this.linkMapContainerId=this.$linkMapContainer.attr("id")}async render(){await o.Z.requireLibrary(o.Z.LINK_MAP),jsPlumb.ready(()=>{this.options.stopCheckerCallback()||(this.initJsPlumbInstance(),this.initPanZoom(),this.loadNotesAndRelations())})}async loadNotesAndRelations(t={}){if(this.options=Object.assign(this.options,t),this.cleanup(),this.options.stopCheckerCallback())return;const n=await i.Z.post(`notes/${this.note.noteId}/link-map`,{maxNotes:this.options.maxNotes,maxDepth:this.options.maxDepth}),e=new Set(n.map(t=>t.noteId).concat(n.map(t=>t.targetNoteId)));0===e.size&&e.add(this.note.noteId);const o=await s.Z.getNotes(Array.from(e),!0),r=new Springy.Graph;r.addNodes(...e),r.addEdges(...n.map(t=>[t.noteId,t.targetNoteId]));const l=new Springy.Layout.ForceDirected(r,this.options.stopCheckerCallback,400,600,.15,.1),d=t=>{const n=this.noteIdToId(t),e=$("#"+n);if(e.length>0)return e;const i=o.find(n=>n.noteId===t);if(!i)return null;const s=$("<div>").addClass("note-box").prop("id",n);return a.Z.createNoteLink(t,{title:i.title}).then(t=>{t.on("click",n=>{try{t.tooltip("dispose")}catch(n){}a.Z.goToLink(n)}),s.append($("<span>").addClass("title").append(t))}),t===this.note.noteId&&s.addClass("link-map-active-note"),s.mouseover(()=>this.$linkMapContainer.find(".link-"+t).addClass("jsplumb-connection-hover")).mouseout(()=>this.$linkMapContainer.find(".link-"+t).removeClass("jsplumb-connection-hover")),this.$linkMapContainer.append(s),this.jsPlumbInstance.draggable(s[0],{start:t=>{this.renderer.stop()},drag:t=>{},stop:t=>{}}),s};this.options.stopCheckerCallback()||(this.renderer=new Springy.Renderer(l),await this.renderer.start(500),l.eachNode((t,n)=>{const e=d(t.id),o=this.$linkMapContainer.width()/2,i=this.$linkMapContainer.height()/2;e.css("left",o+100*n.p.x+"px").css("top",i+100*n.p.y+"px"),e.hasClass("link-map-active-note")&&this.moveToCenterOfElement(e[0])}),l.eachEdge(t=>{const n=this.linkMapContainerId+"-"+t.source.id+"-"+t.target.id;if($("#"+n).length>0)return;d(t.source.id),d(t.target.id);const e=this.jsPlumbInstance.connect({source:this.noteIdToId(t.source.id),target:this.noteIdToId(t.target.id),type:"link"});e&&$(e.canvas).prop("id",n).addClass("link-"+t.source.id).addClass("link-"+t.target.id)}),this.jsPlumbInstance.repaintEverything())}moveToCenterOfElement(t){const n=this.pzInstance.getOwner(),e=()=>{const e=t.getBoundingClientRect(),o=n.getBoundingClientRect(),i=-e.left+o.left+o.width/2-e.width/2,s=-e.top+o.top+o.height/2-e.height/2,a=this.pzInstance.getTransform(),r=a.x+i,l=a.y+s;this.pzInstance.moveTo(r,l)};let o=!1;new IntersectionObserver(t=>{!o&&t[0].isIntersecting&&(o=!0,e())},{rootMargin:"0px",threshold:.1}).observe(n)}initPanZoom(){this.pzInstance||(this.pzInstance=panzoom(this.$linkMapContainer[0],{maxZoom:2,minZoom:.3,smoothScroll:!1,filterKey:function(t,n,e,o){return t.altKey}}))}cleanup(){this.renderer&&this.renderer.stop(),this.jsPlumbInstance&&(this.jsPlumbInstance.deleteEveryEndpoint(),this.$linkMapContainer.empty(),this.pzInstance.zoomAbs(0,0,this.options.zoom),this.pzInstance.moveTo(0,0))}initJsPlumbInstance(){this.jsPlumbInstance?this.cleanup():(this.jsPlumbInstance=jsPlumb.getInstance({Endpoint:["Blank",{}],ConnectionOverlays:r,PaintStyle:{stroke:"var(--muted-text-color)",strokeWidth:1},HoverPaintStyle:{stroke:"var(--main-text-color)",strokeWidth:1},Container:this.$linkMapContainer.attr("id")}),this.jsPlumbInstance.registerConnectionType("link",{anchor:"Continuous",connector:"Straight",overlays:r}))}noteIdToId(t){return this.linkMapContainerId+"-note-"+t}}}}]);
//# sourceMappingURL=694.desktop.js.map