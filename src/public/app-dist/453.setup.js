(window.webpackJsonptrilium=window.webpackJsonptrilium||[]).push([[453],{453:(e,t,i)=>{"use strict";i.r(t),i.d(t,{showDialog:()=>g});var a=i(800),n=i(885),o=i(481);const l={initAttributeNameAutocomplete:function({$el:e,attributeType:t,open:i}){e.hasClass("aa-input")||e.autocomplete({appendTo:document.querySelector("body"),hint:!1,openOnFocus:!0,minLength:0,tabAutocomplete:!1},[{displayKey:"name",cache:!1,source:async(e,i)=>{const n="function"==typeof t?t():t;i((await a.Z.get(`attributes/names/?type=${n}&query=${encodeURIComponent(e)}`)).map(e=>({name:e})))}}]),i&&e.autocomplete("open")},initLabelValueAutocomplete:async function({$el:e,open:t}){if(!e.hasClass("aa-input")){const t=e.parent().parent().find(".attribute-name").val();if(""===t.trim())return;const i=(await a.Z.get("attributes/values/"+encodeURIComponent(t))).map(e=>({value:e}));if(0===i.length)return;e.autocomplete({appendTo:document.querySelector("body"),hint:!1,openOnFocus:!0,minLength:0,tabAutocomplete:!1},[{displayKey:"value",source:function(e,t){e=e.toLowerCase(),t(i.filter(t=>t.value.toLowerCase().includes(e)))}}])}t&&e.autocomplete("open")}};var r=i(46),s=i(985),u=i(707),c=i(847),d=i(95);const p=$("#attributes-dialog"),b=$("#save-attributes-button"),m=$("#owned-attributes-table tbody");function f(){const e=this;async function t(t,a){const n=a.filter(e=>e.noteId===t);for(const e of n)e.labelValue="label"===e.type?e.value:"",e.relationValue="relation"===e.type?await o.Z.getNoteTitle(e.value):"",e.selectedPath="relation"===e.type?e.value:"",e.labelDefinition="label-definition"===e.type&&e.value?e.value:{labelType:"text",multiplicityType:"singlevalue",isPromoted:!0,numberPrecision:0},e.relationDefinition="relation-definition"===e.type&&e.value?e.value:{multiplicityType:"singlevalue",inverseRelation:"",isPromoted:!0},delete e.value;e.ownedAttributes(n.map(ko.observable)),i();const l=a.filter(e=>e.noteId!==t);e.inheritedAttributes(l)}function i(){const t=e.ownedAttributes().filter(e=>!e().isDeleted),i=0===t.length?null:t[t.length-1]();i&&""===i.name.trim()||e.ownedAttributes.push(ko.observable({attributeId:"",type:"label",name:"",labelValue:"",relationValue:"",isInheritable:!1,isDeleted:!1,position:0,labelDefinition:{labelType:"text",multiplicityType:"singlevalue",isPromoted:!0,numberPrecision:0},relationDefinition:{multiplicityType:"singlevalue",inverseRelation:"",isPromoted:!0}}))}this.ownedAttributes=ko.observableArray(),this.inheritedAttributes=ko.observableArray(),this.availableTypes=[{text:"Label",value:"label"},{text:"Label definition",value:"label-definition"},{text:"Relation",value:"relation"},{text:"Relation definition",value:"relation-definition"}],this.availableLabelTypes=[{text:"Text",value:"text"},{text:"Number",value:"number"},{text:"Boolean",value:"boolean"},{text:"Date",value:"date"},{text:"URL",value:"url"}],this.multiplicityTypes=[{text:"Single value",value:"singlevalue"},{text:"Multi value",value:"multivalue"}],this.typeChanged=function(t,i){e.getTargetAttribute(i.target).valueHasMutated()},this.labelTypeChanged=function(t,i){e.getTargetAttribute(i.target).valueHasMutated()},this.updateAttributePositions=function(){let t=10;m.find('input[name="position"]').each((function(){e.getTargetAttribute(this)().position=t,t+=10}))},this.loadAttributes=async function(){const e=d.default.tabManager.getActiveTabNoteId(),i=await a.Z.get("notes/"+e+"/attributes");await t(e,i),setTimeout(()=>$(".attribute-type-select:last").trigger("focus"),1e3)},this.deleteAttribute=function(t,a){const n=e.getTargetAttribute(a.target),o=n();o&&(o.isDeleted=!0,n(o),i())},this.save=async function(){if(b.trigger("focus"),!function(){for(let t=e.ownedAttributes(),i=0;i<t.length;i++)if(e.isEmptyName(i)||e.isEmptyRelationTarget(i))return!1;return!0}())return void alert("Please fix all validation errors and try saving again.");e.updateAttributePositions();const i=d.default.tabManager.getActiveTabNoteId(),l=e.ownedAttributes().map(e=>e()).filter(e=>""!==e.attributeId||""!==e.name);for(const e of l)"label"===e.type?e.value=e.labelValue:"relation"===e.type?e.value=o.Z.getNoteIdFromNotePath(e.selectedPath):"label-definition"===e.type?e.value=JSON.stringify(e.labelDefinition):"relation-definition"===e.type&&(e.value=JSON.stringify(e.relationDefinition)),delete e.labelValue,delete e.relationValue,delete e.labelDefinition,delete e.relationDefinition;const r=await a.Z.put("notes/"+i+"/attributes",l);await t(i,r),n.default.showMessage("Attributes have been saved.")},this.attributeChanged=function(t,a){i(),e.getTargetAttribute(a.target).valueHasMutated()},this.isEmptyName=function(t){const i=e.ownedAttributes()[t]();return!i.name.trim()&&!i.isDeleted&&(!!i.attributeId||("relation-definition"===i.type||"label-definition"===i.type||(!("label"!==i.type||!i.labelValue)||!("relation"!==i.type||!i.relationValue))))},this.isEmptyRelationTarget=function(t){const i=e.ownedAttributes()[t]();return"relation"===i.type&&!i.isDeleted&&i.name&&!i.relationValue},this.getTargetAttribute=function(t){const i=ko.contextFor(t).$index();return e.ownedAttributes()[i]}}let h;async function g(){await u.Z.requireLibrary(u.Z.KNOCKOUT),h||(h=new f,ko.bindingHandlers.noteLink={init:async function(e,t,i,a,n){const o=ko.unwrap(t());if(o){const t=await s.Z.createNoteLink(o);$(e).append(t)}}},ko.bindingHandlers.noteAutocomplete={init:function(e,t,i,a,n){c.Z.initNoteAutocomplete($(e)),$(e).setSelectedPath(n.$data.selectedPath),$(e).on("autocomplete:selected",(function(t,i,a){n.$data.selectedPath=$(e).val().trim()?i.path:""}))}},ko.applyBindings(h,p[0])),await h.loadAttributes(),r.Z.openDialog(p)}p.on("focus",".attribute-name",(function(e){l.initAttributeNameAutocomplete({$el:$(this),attributeType:()=>{const e=h.getTargetAttribute(this);return"relation"===e().type||"relation-definition"===e().type?"relation":"label"},open:!0})})),p.on("focus",".label-value",(function(e){l.initLabelValueAutocomplete({$el:$(this),open:!0})}))},707:(e,t,i)=>{"use strict";i.d(t,{Z:()=>l});const a={};async function n(e){a[e]||(a[e]=$.ajax({url:e,dataType:"script",cache:!0})),await a[e]}async function o(e){Array.from(document.querySelectorAll("link")).map(e=>e.href).some(t=>t.endsWith(e))||$("head").append($('<link rel="stylesheet" type="text/css" />').attr("href",e))}const l={requireCss:o,requireLibrary:async function(e){if(e.css&&e.css.map(e=>o(e)),e.js)for(const t of e.js)await n(t)},CKEDITOR:{js:["libraries/ckeditor/ckeditor.js"]},CODE_MIRROR:{js:["libraries/codemirror/codemirror.js","libraries/codemirror/addon/mode/loadmode.js","libraries/codemirror/addon/fold/xml-fold.js","libraries/codemirror/addon/edit/matchbrackets.js","libraries/codemirror/addon/edit/matchtags.js","libraries/codemirror/addon/search/match-highlighter.js","libraries/codemirror/mode/meta.js","libraries/codemirror/addon/lint/lint.js","libraries/codemirror/addon/lint/eslint.js"],css:["libraries/codemirror/codemirror.css","libraries/codemirror/addon/lint/lint.css"]},ESLINT:{js:["libraries/eslint.js"]},COMMONMARK:{js:["libraries/commonmark.min.js"]},RELATION_MAP:{js:["libraries/jsplumb.js","libraries/panzoom.js"],css:["stylesheets/relation_map.css"]},LINK_MAP:{js:["libraries/jsplumb.js","libraries/panzoom.js","libraries/springy.js"],css:["stylesheets/link_map.css"]},PRINT_THIS:{js:["libraries/printThis.js"]},KNOCKOUT:{js:["libraries/knockout.min.js"]},CALENDAR_WIDGET:{css:["stylesheets/calendar.css"]}}},847:(e,t,i)=>{"use strict";i.d(t,{Z:()=>u});var a=i(800),n=i(95),o=i(46);async function l(e,t){const i=await a.Z.get("autocomplete?query="+encodeURIComponent(e)+"&activeNoteId="+n.default.tabManager.getActiveTabNoteId());0===i.length&&i.push({pathTitle:"No results",path:""}),t(i)}function r(e){o.Z.isMobile()||(e.setSelectedPath(""),e.autocomplete("val","").trigger("change"))}function s(e){o.Z.isMobile()||(e.setSelectedPath(""),e.autocomplete("val",""),e.trigger("focus"))}const u={autocompleteSource:l,initNoteAutocomplete:function(e,t){if(e.hasClass("note-autocomplete-input")||o.Z.isMobile())return e;t=t||{},e.addClass("note-autocomplete-input");const i=$("<a>").addClass("input-group-text input-clearer-button bx bx-x").prop("title","Clear text field"),a=$("<a>").addClass("input-group-text show-recent-notes-button bx bx-time").prop("title","Show recent notes"),n=$("<a>").addClass("input-group-text go-to-selected-note-button bx bx-arrow-to-right").attr("data-action","note"),u=$("<div>").addClass("input-group-append").append(i).append(a);return t.hideGoToSelectedNoteButton||u.append(n),e.after(u),i.on("click",()=>r(e)),a.on("click",t=>(s(e),!1)),e.autocomplete({appendTo:document.querySelector("body"),hint:!1,autoselect:!0,openOnFocus:!0,minLength:0,tabAutocomplete:!1},[{source:l,displayKey:"pathTitle",templates:{suggestion:function(e){return e.highlightedTitle}},cache:!1}]),e.on("autocomplete:selected",(t,i)=>e.setSelectedPath(i.path)),e.on("autocomplete:closed",()=>{e.val().trim()||r(e)}),e},showRecentNotes:s,init:function(){$.fn.getSelectedPath=function(){return $(this).val().trim()?$(this).attr("data-note-path"):""},$.fn.setSelectedPath=function(e){e=e||"",$(this).attr("data-note-path",e),$(this).closest(".input-group").find(".go-to-selected-note-button").toggleClass("disabled",!e.trim()).attr("data-note-path",e)}}}}}]);
//# sourceMappingURL=453.setup.js.map